{{- if .Values.rhtpa.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rhtpa-cr-creator-script
  namespace: {{ .Values.rhtpa.namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "18"
data:
  create-cr.sh: |
    #!/bin/bash
    set -e
    
    echo "Waiting for SPIFFE workload API to be ready..."
    
    # Wait for SPIFFE socket
    for i in {1..60}; do
      if [ -S "/spiffe-workload-api/spire-agent.sock" ]; then
        echo "SPIFFE workload API ready"
        break
      fi
      echo "Waiting for SPIFFE socket... ($i/60)"
      sleep 5
    done
    
    # Wait for S3 secret (OBC) - still needed for S3 credentials
    echo "Waiting for S3 secret..."
    for i in {1..60}; do
      if oc get secret {{ .Values.rhtpa.objectStorage.objectBucketClaim.name }} -n {{ .Values.rhtpa.namespace }} >/dev/null 2>&1; then
        echo "S3 secret found"
        break
      fi
      echo "Waiting for S3 secret... ($i/60)"
      sleep 5
    done
    
    echo "Extracting credentials..."
    
    # Wait for SPIFFE helper to generate JWT token
    echo "Waiting for SPIFFE JWT token..."
    for i in {1..60}; do
      if [ -f "/run/secrets/spiffe/jwt.token" ] && [ -s "/run/secrets/spiffe/jwt.token" ]; then
        echo "JWT token found"
        break
      fi
      echo "Waiting for JWT token... ($i/60)"
      sleep 2
    done
    
    if [ ! -f "/run/secrets/spiffe/jwt.token" ] || [ ! -s "/run/secrets/spiffe/jwt.token" ]; then
      echo "ERROR: JWT token not found or empty after waiting"
      exit 1
    fi
    
    # Get database password from Vault using SPIFFE authentication
    # Note: Vault should use alphaNumericPolicy for URL-safe passwords
    echo "Fetching database password from Vault using SPIFFE..."
    export VAULT_URL="${VAULT_ADDR}"
    export VAULT_SECRET_PATH="{{ .Values.rhtpa.database.passwordVaultKey }}"
    export VAULT_ROLE="{{ .Values.rhtpa.zeroTrust.vault.role }}"
    export JWT_TOKEN_FILE="/run/secrets/spiffe/jwt.token"
    
    # Copy the Python script to a writable location (ConfigMap volumes are read-only)
    cp /usr/local/bin/rhtpa-spiffe-vault-client.py /tmp/rhtpa-spiffe-vault-client.py
    chmod +x /tmp/rhtpa-spiffe-vault-client.py
    
    # Run the script from the writable location
    # Redirect stderr to a temp file to avoid capturing logs in the password variable
    if ! DB_PASSWORD=$(python3 /tmp/rhtpa-spiffe-vault-client.py --key db-password 2>/tmp/vault-error.log); then
      echo "ERROR: Failed to retrieve database password from Vault"
      cat /tmp/vault-error.log
      exit 1
    fi
    
    if [ -z "$DB_PASSWORD" ]; then
      echo "ERROR: Database password is empty"
      cat /tmp/vault-error.log
      exit 1
    fi
    
    echo "Database password retrieved from Vault (length: ${#DB_PASSWORD})"
    echo "NOTE: Password should be alphanumeric only (URL-safe)"
    
    # Store database password in a Kubernetes secret for the operator to reference
    echo "Creating database credential secret..."
    oc create secret generic rhtpa-db-credentials \
      -n {{ .Values.rhtpa.namespace }} \
      --from-literal=username={{ .Values.rhtpa.database.username }} \
      --from-literal=password="${DB_PASSWORD}" \
      --dry-run=client -o yaml | oc apply -f -
    
    echo "Database credentials secret created/updated"
    
    # Get S3 credentials from OBC secret (these are generated by NooBaa, not in Vault)
    S3_ACCESS_KEY=$(oc get secret {{ .Values.rhtpa.objectStorage.objectBucketClaim.name }} -n {{ .Values.rhtpa.namespace }} -o jsonpath='{.data.AWS_ACCESS_KEY_ID}' | base64 -d)
    S3_SECRET_KEY=$(oc get secret {{ .Values.rhtpa.objectStorage.objectBucketClaim.name }} -n {{ .Values.rhtpa.namespace }} -o jsonpath='{.data.AWS_SECRET_ACCESS_KEY}' | base64 -d)
    S3_BUCKET=$(oc get obc {{ .Values.rhtpa.objectStorage.objectBucketClaim.name }} -n {{ .Values.rhtpa.namespace }} -o jsonpath='{.spec.bucketName}')
    
    echo "All credentials extracted successfully"
    
    # Check if CR already exists
    if oc get trustedprofileanalyzer {{ .Values.rhtpa.name }} -n {{ .Values.rhtpa.namespace }} >/dev/null 2>&1; then
      echo "TrustedProfileAnalyzer CR already exists, skipping creation"
      exit 0
    fi
    
    echo "Creating TrustedProfileAnalyzer CR with real credentials..."
    
    # Create the CR with real credentials (NOT PLACEHOLDER!)
    # Use bash variable substitution (envsubst not available in ose-cli image)
    cat <<EOFTEMPLATE | oc apply -f -
    apiVersion: rhtpa.io/v1
    kind: TrustedProfileAnalyzer
    metadata:
      name: {{ .Values.rhtpa.name }}
      namespace: {{ .Values.rhtpa.namespace }}
      labels:
        {{- include "rhtpa-operator.labels" . | nindent 8 }}
    spec:
      appDomain: {{ printf "%s.%s" (.Values.rhtpa.routePrefix | default "trustify-server") .Values.global.localClusterDomain | quote }}
      
      {{- if .Values.rhtpa.tls.ingressCA.enabled }}
      tls:
        additionalTrustAnchor: /etc/rhtpa/tls/ca.crt
      {{- end }}
      
      {{- if .Values.rhtpa.zeroTrust.keycloak.enabled }}
      oidc:
        clients:
          frontend:
            issuerUrl: {{ include "rhtpa-operator.keycloakOIDCIssuer" . | quote }}
          cli:
            issuerUrl: {{ include "rhtpa-operator.keycloakOIDCIssuer" . | quote }}
            clientSecret:
              valueFrom:
                secretKeyRef:
                  name: oidc-cli
                  key: client-secret
      {{- end }}
      
      createDatabase:
        name: {{ .Values.rhtpa.database.name }}
        username: {{ .Values.rhtpa.database.username }}
        password: "${DB_PASSWORD}"
      
      migrateDatabase: {}
      
      modules:
        migrateDatabase:
          enabled: true
        
        # Database creation module
        createDatabase:
          enabled: {{ .Values.rhtpa.modules.createDatabase.enabled | default true }}
          
        # Importers configuration
        createImporters:
          enabled: {{ .Values.rhtpa.modules.createImporters.enabled | default true }}
          importers:
            cve:
              cve:
                disabled: {{ .Values.rhtpa.modules.createImporters.importers.cve.cve.disabled | default false }}
                period: {{ .Values.rhtpa.modules.createImporters.importers.cve.cve.period | default "1d" }}
                source: {{ .Values.rhtpa.modules.createImporters.importers.cve.cve.source | default "https://github.com/CVEProject/cvelistV5" }}
            osv-github:
              osv:
                disabled: {{ (index .Values.rhtpa.modules.createImporters.importers "osv-github").osv.disabled | default false }}
                period: {{ (index .Values.rhtpa.modules.createImporters.importers "osv-github").osv.period | default "1d" }}
                source: {{ (index .Values.rhtpa.modules.createImporters.importers "osv-github").osv.source | default "https://github.com/github/advisory-database" }}
                
        # Runtime configuration
        importer:
          replicas: {{ .Values.rhtpa.modules.importer.replicas | default 1 }}
          resources:
            requests:
              cpu: {{ .Values.rhtpa.modules.importer.resources.requests.cpu | default "0.5" | quote }}
              memory: {{ .Values.rhtpa.modules.importer.resources.requests.memory | default "4Gi" }}
              
        server:
          replicas: {{ .Values.rhtpa.modules.server.replicas | default 1 }}
          resources:
            requests:
              cpu: {{ .Values.rhtpa.modules.server.resources.requests.cpu | default "0.5" | quote }}
              memory: {{ .Values.rhtpa.modules.server.resources.requests.memory | default "4Gi" }}

      database:
        host: rhtpa-db.{{ .Values.rhtpa.namespace }}.svc.cluster.local
        name: {{ .Values.rhtpa.database.name }}
        username:
          valueFrom:
            secretKeyRef:
              name: rhtpa-db-credentials
              key: username
        password:
          valueFrom:
            secretKeyRef:
              name: rhtpa-db-credentials
              key: password
      
      storage:
        type: s3
        accessKey: "${S3_ACCESS_KEY}"
        secretKey: "${S3_SECRET_KEY}"
        bucket: "${S3_BUCKET}"
        region: {{ .Values.rhtpa.objectStorage.region | default "us-east-1" | quote }}
      
      {{- if .Values.rhtpa.tls.ingressCA.enabled }}
      extraVolumes:
        - name: ingress-ca
          configMap:
            name: rhtpa-ingress-ca
      
      extraVolumeMounts:
        - name: ingress-ca
          mountPath: /etc/rhtpa/tls
          readOnly: true
      {{- end }}
    EOFTEMPLATE
    
    echo "TrustedProfileAnalyzer CR created successfully with real credentials!"
{{- end }}

